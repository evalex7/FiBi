
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document.
     * @param resource The document resource.
     */
    function isOwner(resource) {
      return isSignedIn() && request.auth.uid == resource.data.familyMemberId;
    }

    /**
     * @description Checks if the incoming data owner matches the authenticated user.
     * @param request The request object.
     */
    function isOwnerOfNewData(request) {
        return isSignedIn() && request.auth.uid == request.resource.data.familyMemberId;
    }
    
    /**
     * @description Generic rule to check if a user can read data (signed in).
     */
    function canReadData() {
        return isSignedIn();
    }

    /**
     * @description Rules for user profiles.
     */
    match /users/{userId} {
      allow get: if canReadData();
      allow create, update, delete: if isSignedIn() && request.auth.uid == userId;
      allow list: if false; // Disallow listing all users for security.
    }

    /**
     * @description Rules for categories.
     */
    match /categories {
        allow list: if canReadData();
    }
    match /categories/{categoryId} {
      allow get: if canReadData();
      allow create: if isOwnerOfNewData(request);
      allow update, delete: if isOwner(resource);
    }
    
    /**
     * @description Rules for expenses.
     */
    match /expenses {
       allow list: if canReadData();
    }
    match /expenses/{expenseId} {
      allow get: if canReadData();
      allow create: if isOwnerOfNewData(request);
      allow update, delete: if isOwner(resource);
    }

    /**
     * @description Rules for budgets.
     */
    match /budgets {
        allow list: if canReadData();
    }
    match /budgets/{budgetId} {
      allow get: if canReadData();
      allow create: if isOwnerOfNewData(request);
      allow update, delete: if isOwner(resource);
    }
    
    /**
     * @description Rules for recurring payments.
     */
    match /payments {
        allow list: if canReadData();
    }
    match /payments/{paymentId} {
       allow get: if canReadData();
       allow create: if isOwnerOfNewData(request);
       allow update, delete: if isOwner(resource);
    }

    /**
     * @description Rules for goals.
     */
    match /goals {
      allow list: if canReadData();
    }
    match /goals/{goalId} {
      allow get: if canReadData();
      allow create: if isOwnerOfNewData(request);
      allow update, delete: if isOwner(resource);
    }
  }
}
